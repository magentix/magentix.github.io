<!DOCTYPE html>
<!--
  __    __     ______     ______     ______     __   __     ______    __     __  __
 /\ "-./  \   /\  __ \   /\  ___\   /\  ___\   /\ "-.\ \   /\__  _\  /\ \   /\_\_\_\
 \ \ \-./\ \  \ \  __ \  \ \ \__ \  \ \  __\   \ \ \-.  \  \/_/\ \/  \ \ \  \/_/\_\/_
  \ \_\ \ \_\  \ \_\ \_\  \ \_____\  \ \_____\  \ \_\\"\_\    \ \_\   \ \_\   /\_\/\_\
   \/_/  \/_/   \/_/\/_/   \/_____/   \/_____/   \/_/ \/_/     \/_/    \/_/   \/_/\/_/
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Protocole Gemini : retour d'expérience</title>
        <meta name="description" content="Gemini est un protocole dédié à la diffusion de contenu, imaginé pour être simple et respectueux de la vie privée." />
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' cdn.magentix.fr; base-uri 'self'" />
        <link rel="stylesheet" href="https://www.magentix.fr/css/style.css" />
        <meta name="robots" content="INDEX,FOLLOW" />
    </head>
    <body>
        <header>
            <div id="header-content">
                <h1><a href="https://www.magentix.fr/"><img src="https://www.magentix.fr/media/magentix.png" alt="magentix" width="232" height="60" /></a></h1>
                <p>Développeur Magento indépendant depuis 2009</p>
                <nav>
                    <a href="https://www.magentix.fr/">Accueil</a> &bull;
                    <a href="https://www.magentix.fr/blog.html">Billets</a>
                </nav>
            </div>
        </header>
        <main>
            <div id="main-content">
<p><a href="https://www.magentix.fr/blog.html">Billets</a> : Protocole Gemini : retour d'expérience</p>
<hr/>

<h2>Protocole Gemini : retour d'expérience</h2>

<p class="author"><span>Par Matthieu le 07/02/2022</span></p>

<p>
    <em>Gemini est un protocole dédié à la diffusion de contenu. Une alternative à HTTP imaginé pour être simple et respectueux de la vie privée. L'idée a du sens mais le protocole souffre de quelques défauts...</em>
</p>

<hr />
<p>Pour bien comprendre la philosophie de <strong>Gemini</strong>, comparons le avec <strong>HTTP</strong>.</p>
<h3>HTTP vs Gemini</h3>
<h4>HTTP</h4>
<section>
<p><strong>Requête :</strong></p>
<pre><code>GET /index.html HTTP/1.1
Host: example.com
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
X-What-I-Want: Foo
</code></pre>
<p><strong>Réponse :</strong></p>
<pre><code class="language-html">HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Set-Cookie: PHPSESSID=be071caaf83bf8539310818360720a84
X-What-I-Want: Bar

&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Hello World!&lt;/title&gt;
    &lt;/head&gt;
&lt;/html&gt;
&lt;body&gt;
    &lt;h1&gt;Welcome!&lt;/h1&gt;
    &lt;p&gt;This is a page&lt;/p&gt;
&lt;/body&gt;
</code></pre>
</section>
<h4>Gemini</h4>
<section>
<p><strong>Requête :</strong></p>
<pre><code>gemini://example.com/index.gmi
</code></pre>
<p><strong>Réponse :</strong></p>
<pre><code class="language-gemtext">20 text/gemini
# Welcome !

This is a page
</code></pre>
</section>
<h3>Philosophie</h3>
<p>Gemini se veut simple, léger, rapide, mais surtout... fermé. Il a pour unique vocation de servir du texte dans un format Markdown simplifié appelé <a href="https://gemini.circumlunar.space/docs/gemtext.gmi">Gemtext</a>. La requête et l'en-tête de réponse sont sur une seule ligne, empêchant toute extensibilité. Il est impossible avec le protocole Gemini de créer quelque chose qui s'apparente à un cookie. Pas de session ni de traçage des internautes.</p>
<p>C'est une réponse extrême aux dérives du web. Gemini est parfaitement présenté par <a href="http://ploum.net/">Ploum</a> dans l'article <a href="https://ploum.net/gemini-le-protocole-du-slow-web/">Gemini, le protocole du slow web</a>.</p>
<p><img alt="Gemini via le navigateur Lagrange" height="488" src="https://www.magentix.fr/media/blog/articles/gemini-lagrange.png" width="776" /></p>
<h3>Retour d'expérience</h3>
<p>Nous sommes sur un exemple parfait d'idéologie à des années-lumières de ce qu'est le web et de ce qu'il tend à devenir. C'est un mouvement protestataire, initié par un certain <a href="https://www.circumlunar.space/~solderpunk/">Solderpunk</a> et relayé par quelques personnalités comme Drew DeVault : <a href="https://drewdevault.com/2020/11/01/What-is-Gemini-anyway.html">What is this Gemini thing anyway, and why am I excited about it?</a> ou Stéphane Bortzmeyer : <a href="https://www.bortzmeyer.org/gemini.html">Le protocole Gemini, revenir à du simple et sûr pour distribuer l'information en ligne ?</a>. On parle également de Gemini dans quelques débats sur <a href="https://news.ycombinator.com/">Hacker News</a>.</p>
<p>En naviguant sur les capsules (sites Gemini), on découvre le partage de technophiles altruistes, de philosophes, de poètes (beaucoup d'haiku), d'écrivains amateurs, d'artistes ASCII Art, ou encore d'écologistes low-tech. On y trouve quelques fans de <a href="https://fr.wikipedia.org/wiki/Gopher">Gopher</a>, habitués à ces espaces cachés, loin de toute agitation.</p>
<p>Pour partager du contenu via le protocole Gemini, il faut un serveur à disposition et quelques connaissances en administration système. Certains proposent un service d'hébergement, mais c'est de mon point de vue un peu délicat de poser des fichiers sur un serveur dont on ignore s'il sera encore à disposition le lendemain.</p>
<p>On déplore malheureusement beaucoup de capsules à l'abandon, fermées ou juste là pour le challenge technique. Pour ma part, je me suis trouvé rapidement limité par le Gemtext très simpliste, avec l'impossibilité même d'afficher un texte en gras. Pour la rédaction d'articles techniques ou scientifiques, le format n'est pas adapté. Trop limité et austère. Les capsules manquent finalement d'identité.</p>
<p>Il faut donc accepter de partager simplement une idée, une opinion, un état d'âme ou une histoire, sans échange ni retour. Une bouteille à la mer.</p>
<p>Des demandes ont été formulées pour faire évoluer les <a href="https://gemini.circumlunar.space/docs/specification.gmi">spécifications</a> : ajouter des fonctionnalités comme des formulaires, le partage de fichiers ou de l'échange par message. Cela est sujet à des débats sans fin. Pour Drew DeVault cela n'a pas de sens :</p>
<blockquote>
<p>Gemini is not a protocol for publishing. We use a different protocol for that, like git or rsync. It's not interactive, either, at least not in the same sense as the web is. It is a protocol for consumption: for reading hyperlinked Gemtext documents.</p>
</blockquote>
<p>Solderpunk, après plusieurs mois d'absence, a également mis les choses au point. Concernant le Gemtext il annonce :</p>
<blockquote>
<p>Additional capacities in the gemtext format are not necessary. That's not just, like, my opinion, man, that's an empirical fact. Geminispace is there. It's <em>exactly</em> the kind of space I originally envisaged.</p>
</blockquote>
<p>Gemini restera donc ce qu'il est. Il ne convient pas pour ce que je souhaite partager, mais je continue d'y naviguer à mes heures perdues.</p>
<p>Techniquement, le protocole est plutôt intéressant : il permet de mettre en place son propre serveur, le maîtriser de A à Z. Gemini laisse place à la créativité.</p>
<h3>Un serveur Gemini</h3>
<h4>TCP</h4>
<p>La lecture des <a href="https://gemini.circumlunar.space/docs/specification.gmi">spécifications</a> ne demande que quelques minutes. Ce pourrait être un parfait sujet de TP dans le cadre d'une formation en réseau et développement : "développer un serveur et un client respectant les spécifications décrites dans ce document". La simplicité a d'ailleurs séduit une multitude de développeurs, on trouve des serveurs et clients Gemini dans tous les langages : Java, Python, Rust, Go, PHP, C, Perl, shell, Kotlin, Ruby, Erlang... Certains ultra légers, d'autres plus complets avec par exemple la gestion d'une authentification TOFU ou l'utilisation de scripts CGI.</p>
<p>Le serveur consiste en l'intégration d'un socket à l'écoute des requêtes envoyées au port 1965, et d'y répondre avec le contenu sollicité. Comme pour HTTP 1 et 2, Gemini utilise TCP comme couche de transport. Un aspect sécurité est bien attendu à prendre en compte, car il ne s'agit pas d'exposer au monde l'intégralité des fichiers d'une machine. Notez qu'avec Gemini, TLS est obligatoire. Il faut générer un certificat (auto-signé ou non) au préalable.</p>
<p>Pour tester rapidement, on installe <strong>nmap</strong> (ou <strong>ncat</strong> directement si disponible) :</p>
<pre><code class="language-bash">apt install nmap
</code></pre>
<p>On génère un certificat auto-signé (sans passphrase, avec le FQDN du serveur) :</p>
<pre><code class="language-bash">openssl req -nodes -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365
</code></pre>
<p>On ouvre enfin une connexion TCP sur le port 1965 via ncat :</p>
<pre><code class="language-bash">while true ; do echo -e &quot;20 text/gemini\r\nHello!&quot; | ncat -lvnp 1965 --ssl --ssl-key key.pem --ssl-cert cert.pem ; done
</code></pre>
<p>L'accès au serveur via n'importe quel client Gemini (par exemple <a href="https://github.com/skyjake/lagrange">Lagrange</a> ou <a href="https://play.google.com/store/apps/details?id=ca.snoe.deedum&amp;hl=fr&amp;gl=US">deedum</a> sur Android) affiche :</p>
<pre><code>Hello!
</code></pre>
<p>On peut également transmettre une requête en ligne de commande avec <strong>ncat</strong> ou <strong>openssl</strong> :</p>
<pre><code class="language-bash">echo &quot;gemini://127.0.0.1/&quot; | ncat --ssl 127.0.0.1 1965
</code></pre>
<pre><code class="language-bash">echo &quot;gemini://127.0.0.1/&quot; | openssl s_client -connect 127.0.0.1:1965 -crlf -quiet -ign_eof 2&gt; /dev/null
</code></pre>
<p>Dans cet exemple la requête n'a aucune importance, la réponse est toujours la même.</p>
<h4>Requête</h4>
<p>Une requête Gemini est de la forme : <code>{scheme}://{host}/{path}</code></p>
<ul>
<li><strong>scheme</strong> : gemini <em>(une autre valeur engendre une erreur 53 ou 59)</em></li>
<li><strong>host</strong> : IP ou domaine <em>(utile pour gérer plusieurs hosts sur un même serveur)</em></li>
<li><strong>path</strong> : chemin de la page</li>
</ul>
<p>Par exemple : <code>gemini://example.com/index.gmi</code></p>
<pre><code class="language-bash">echo &quot;gemini://gemini.circumlunar.space/&quot; | ncat --ssl gemini.circumlunar.space 1965
</code></pre>
<h4>En-tête de réponse</h4>
<p>Les codes de statut sont sur 2 digits, il y en a 18 au total (le <em>11 SENSITIVE INPUT</em> est cependant sur la sellette car non approprié au concept). On retiendra les statuts suivants :</p>
<ul>
<li>20 SUCCESS</li>
<li>31 REDIRECT - PERMANENT</li>
<li>50 PERMANENT FAILURE</li>
<li>51 NOT FOUND</li>
<li>53 PROXY REQUEST REFUSED</li>
<li>59 BAD REQUEST</li>
</ul>
<p>Les autres statuts ont un intérêt dans des cas particuliers, je ne m'y attarde pas.</p>
<p>On suffixe systématiquement l'en-tête avec CRLF (\r\n).</p>
<h4>Corps de la réponse</h4>
<p>Le corps de la réponse contient du texte, encodé en UTF-8. Pour le Gemtext on indique le mimetype <strong>text/gemini</strong>.</p>
<pre><code class="language-gemtext">20 text/gemini
# Hello!

Welcome to my capsule.

=&gt; ./about.gmi Who am I?
</code></pre>
<p>On pourrait envoyer n'importe quel type de fichier (image/png, audio/mpeg...), avec les données binaires. Mais cela implique que le client puisse les lire ou les proposer au téléchargement. Ce n'est pas le but de Gemini. Peu de clients le font.</p>
<h4>Un peu de code...</h4>
<p>On dispose maintenant de suffisamment d'informations pour coder un serveur Gemini, dans n'importe quel langage. Quelque chose de volontairement assez basique en <strong>PHP 8</strong> ressemble à ceci :</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

const ROOT = __DIR__ . '/';

$resource = stream_context_create(
    [
        'ssl' =&gt; [
            'local_cert' =&gt; ROOT . 'cert.pem',
            'local_pk' =&gt; ROOT . 'key.pem',
            'passphrase' =&gt; 'gemini',
            'allow_self_signed' =&gt; true,
            'verify_peer' =&gt; false,
        ]
    ]
);
$socket = stream_socket_server(address: 'tcp://0:1965', context: $resource);
stream_socket_enable_crypto($socket, false);

while (true) {
    $fSocket = stream_socket_accept($socket, -1);

    stream_set_blocking($fSocket, true);
    @stream_socket_enable_crypto($fSocket, true, STREAM_CRYPTO_METHOD_TLSv1_3_SERVER);
    $url = parse_url(trim(fread($fSocket, 1024)));
    stream_set_blocking($fSocket, false);

    fwrite($fSocket, getContent($url ?: []));
    fclose($fSocket);
}

/**
 * Retrieve the response content
 *
 * @param string[] $url
 * $url = [
 *     'scheme' =&gt; (string) scheme name (gemini)
 *     'host'   =&gt; (string) host name (gemini.circumlunar.space)
 *     'path'   =&gt; (string) requested page (/about.gmi)
 * ]
 *
 * @return string
 */
function getContent(array $url): string
{
    if (($url['scheme'] ?? '') !== 'gemini') {
        return &quot;53 Proxy Request Refused\r\n&quot;;
    }

    $path = $url['path'] ?? '/';
    if (str_ends_with($path, '/')) {
        $path .= 'index.gmi';
    }
    $file = ROOT . 'capsule' . str_replace('../', '', $path);

    if (!str_ends_with($file, 'gmi') || !file_exists($file)) {
        return &quot;51 Not found\r\n&quot;;
    }

    return &quot;20 text/gemini\r\n&quot; . file_get_contents($file);
}
</code></pre>
<aside>server.php</aside>

<p>Dans le même dossier que le script on génère le certificat (indiquez gemini pour la passphrase et le FQDN du serveur pour le nom commun) :</p>
<pre><code class="language-bash">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365
</code></pre>
<pre><code>Enter PEM pass phrase: gemini
Verifying - Enter PEM pass phrase: gemini
Country Name (2 letter code) [AU]: US
State or Province Name (full name) [Some-State]: Washington
Locality Name (eg, city) []: Olympia
Organization Name (eg, company) [Internet Widgits Pty Ltd]: MyCompany
Organizational Unit Name (eg, section) []: IT
Common Name (e.g. server FQDN or YOUR name) []: example.com
Email Address []: hello@example.com
</code></pre>
<p>Puis on démarre le serveur :</p>
<pre><code class="language-bash">php server.php &amp;
</code></pre>
<h3>Conclusion</h3>
<p>L'idée d'un protocole simple, plus sûre et respectueux de la vie privée a du sens. Mais Gemini est de mon point de vue un peu extrême. Le Gemtext est bien trop limité pour apporter du dynamisme à une lecture, de l'identité à une capsule. Il facilite le développement du client, c'est là le but recherché. Mais proposer un Markdown plus complet aurait été bien plus intéressant.</p>
<p>Travailler sur le protocole est tout de même inspirant. On est au plus bas de la couche application (socket), idéal pour un développement hyper léger, optimisé et maîtrisé. On peut tout imaginer. Un ingénieur logiciel, <a href="https://mozz.us/">Michael Lazar</a>, s'est amusé à écrire une <a href="https://portal.mozz.us/spartan/spartan.mozz.us/specification.gmi">spécification</a> (The Spartan Protocol) très inspirée de Gemini.</p>
<p>Au-delà de l'aspect technique, je suis curieux de l'avenir du protocole. Il n'évoluera plus, ou très peu. Il semble bien parti pour suivre le même chemin que Gopher : un espace un peu caché, un lieu d'expression (textuel) pour celles et ceux fatigués par la lourdeur du web que l'on connaît.</p>
<p>Pour allez plus loin avec Gemini :</p>
<ul>
<li><a href="https://github.com/kr1sp1n/awesome-gemini">Awesome Gemini</a></li>
<li><a href="https://geminiquickst.art/">Gemini Quickstart!</a></li>
<li><a href="https://gemini.circumlunar.space/">Project Gemini (circumlunar.space)</a></li>
</ul>
<p class="contact">
    <strong>Une question ?</strong> <span>Contactez-moi sur <a href="https://twitter.com/_magentix">Twitter</a></span>
</p>
            </div>
        </main>
        <footer>
            <div id="footer-content">
                <p><strong>Magentix</strong> © 2009 / 2022</p>
                <p><small>Réalisé avec <a href="https://www.stapy.net">StaPy</a></small></p>
                <nav><a href="https://www.magentix.fr/mentions.html">Mentions légales</a> &bull; <a href="/blog.html">Billets</a></nav>
            </div>
        </footer>
        <script type="text/javascript" src="https://www.magentix.fr/js/highlight.js"></script>
        <script type="text/javascript" src="https://www.magentix.fr/js/app.js"></script>
    </body>
</html>
